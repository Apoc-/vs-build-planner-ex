<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Primary Meta Tags -->
    <title>Vampire Survivors - Build Planner</title>
    <meta name="title" content="Vampire Survivors - Build Planner" />
    <meta name="description" content="Vampire Survivors - Build Planner" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="og:title" content="Vampire Survivors - Build Planner" />
    <meta property="og:description" content="Vampire Survivors - Build Planner" />
    <meta property="og:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="https://danmer.github.io/vs-build-planner" />
    <meta property="twitter:title" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:description" content="Vampire Survivors - Build Planner" />
    <meta property="twitter:image" content="https://danmer.github.io/vs-build-planner/img/preview.jpg" />
    <!-- Styles -->
    <link rel="stylesheet" href="./assets/sprite.css" />
    <style>
      * {
        box-sizing: border-box;
      }
      html {
        font-family: 'Courier New', Courier, monospace;
        line-height: 1;
        -webkit-text-size-adjust: 100%;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0;
        min-height: 100vh;
        background: #333 linear-gradient(-45deg, #000, #422) no-repeat;
        color: #eee;
        white-space: nowrap;
        text-align: center;
      }
      h1 {
        display: flex;
        justify-content: center;
        margin: 0 0 0.5em;
        white-space: normal;
      }
      header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 1em;
      }
      section {
        margin: 0.5em;
      }
      .pixels {
        image-rendering: pixelated;
      }
      .flex {
        display: flex;
      }
      .app {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .slots {
        display: flex;
        /* border: 0.1em solid #888; */
      }
      .slot {
        position: relative;
        flex-shrink: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 2.5em;
        height: 2.5em;
        border: 0.05em solid #aa9;
        background: #333 linear-gradient(-45deg, #222, #998) no-repeat;
        box-shadow: 1px 1px 5px #000;
        transition: transform 0.1s;
        font-size: 2em;
      }
      .slot:not(.character):hover {
        /* background-image: linear-gradient(-45deg, #400, #f66);
        border-color: #f99 !important; */
        background: #333 linear-gradient(-45deg, #333, #bbb) no-repeat;
        transform: scale(1.3);
        z-index: 2;
        cursor: pointer;
      }
      .slot.character {
        /* width: 20vw;
        height: 20vw; */
        width: 5em;
        height: 5em;
        border-width: 0.1em;
      }
      .slot.arcana {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 4em;
        height: 5em;
        overflow: hidden;
      }
      .slot:nth-child(n + 7) {
        opacity: 0.5;
      }
      .slot.arcana > div {
        font-size: 0.85em;
        flex-shrink: 0;
      }
      .objects {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
      }
      .object {
        position: relative;
        margin: 0.2em;
        padding: 0.4em;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        width: 5em;
        height: 5em;
        overflow: hidden;
        border-radius: 0.2em;
        border: 0.15em solid #aa9;
        background: #333 linear-gradient(-45deg, #222, #998) no-repeat;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 1px 1px 5px #000;
      }
      .object:hover {
        /* background-image: linear-gradient(-45deg, #024, #06f);
        border-color: #3cf !important; */
        border: 0.15em solid #ddc;
        background: #333 linear-gradient(-45deg, #333, #ccb) no-repeat;
        transform: scale(1.3);
        z-index: 2;
      }
      .object.selected {
        background-image: linear-gradient(-45deg, #024, #36f);
        border-color: #39f;
      }
      .green {
        background-image: linear-gradient(-45deg, #040, #3c3) !important;
      }
      .yellow {
        background-image: linear-gradient(-45deg, #420, #fc0) !important;
      }

      .object.character,
      .object.passive,
      .object.weapon {
        align-items: flex-start;
        justify-content: flex-end;
      }
      .object.center,
      .object.evolution {
        align-items: center;
        justify-content: center;
      }
      .object.arcana {
        height: 6em;
        overflow: hidden;
      }

      .object > .title {
        position: absolute;
        top: 0.1em;
        left: 0.1em;
        font-size: 0.7em;
      }
      .object > .character {
        position: absolute;
        font-size: 1em;
      }
      .object > .passive,
      .object > .weapon,
      .object > .evolution {
        font-size: 2em;
      }
      .object > .weapons,
      .object > .evolutions {
        position: absolute;
        right: 0.2em;
        top: 0.2em;
        font-size: 0.9em;
      }
      .object > .impacts {
        display: flex;
        margin-top: 0.25em;
        font-size: 0.5em;
      }
      .object > .impacts > div {
        margin: 0 -0.2em !important;
      }
      .empty {
        color: #999;
        font-size: 0.3em;
        font-weight: bold;
      }
      .buttons {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
        font-weight: bold;
        color: #999;
        user-select: none;
      }
      .buttons.settings {
        font-size: 0.7em;
      }
      .buttons .flex .button:nth-child(n + 2) {
        margin-left: 0;
      }
      .button {
        margin: 0.5em 0.5em 0;
        cursor: pointer;
        padding: 0.3em 0.5em;
        background-color: rgba(0, 0, 0, 0.3);
        border-radius: 0.3em;
      }
      .button:hover {
        background-color: rgba(0, 0, 0, 0.5);
        color: #fff;
      }
      footer {
        margin: 1em 0;
        color: #999;
      }
      .socials {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.3em;
      }
      .social {
        margin-left: 0.3em;
        opacity: 0.5;
      }
      .social:hover {
        opacity: 1;
      }
      .social img {
        width: 1em;
        height: 1em;
      }
      .author {
        color: inherit;
        text-decoration: none;
      }
      .author:hover {
        color: #ccc;
        cursor: pointer;
      }
      @media (max-width: 50em) {
        .slots {
          flex-direction: column;
          align-items: center;
        }
        .slots > .flex-1 {
          display: flex;
        }
        .slots > .flex-1 > .flex {
          flex-direction: column;
        }
        h1 {
          flex-direction: column;
        }
        .lg {
          display: none;
        }
        .buttons {
          max-width: 20em;
        }
      }
    </style>
  </head>
  <body>
    <div id="app">
      <main class="app" :class="{pixels: config.pixels}" :style="{fontSize: `${config.size}em`}">
        <!-- Build -->
        <header>
          <h1>
            <span>Vampire Survivors</span>
            <span class="lg">&nbsp;â€”&nbsp;</span>
            <span>Build Planner ({{config.version}})</span>
          </h1>
          <div class="slots">
            <div class="flex">
              <div v-for="arcana in selectedArcanas" :data-id="arcana.id" class="slot arcana selected" :class="arcana.type" @click="toggleItem(arcana)" @mouseenter="onMouseEnter(arcana)" @mouseleave="onMouseLeave(arcana)">
                <div class="sprite" :class="`sprite-${arcana.id}`" :title="arcana.name"></div>
              </div>
            </div>
            <div v-if="selectedCharacter" class="character slot" :title="selectedCharacter.name">
              <div class="sprite" :class="`sprite-${selectedCharacter.id}`"></div>
            </div>
            <div v-else class="character slot">
              <div class="empty">CHARACTER</div>
            </div>
            <div class="flex-1">
              <div class="flex">
                <div v-for="weapon in selectedWeapons" :data-id="weapon.id" class="slot weapon selected" :title="weapon.name" @click="toggleItem(weapon)" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave(weapon)">
                  <div class="sprite" :class="`sprite-${weapon.id}`"></div>
                </div>
                <div v-for="i in (selectedWeapons.length < 7 ? 6 - selectedWeapons.length : 0)" class="slot weapon">
                  <div class="empty">WEAPON</div>
                </div>
              </div>
              <div class="flex">
                <div v-for="passive in selectedPassives" :data-id="passive.id" class="slot passive selected" :title="passive.name" @click="toggleItem(passive)" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave(passive)">
                  <div class="sprite" :class="`sprite-${passive.id}`"></div>
                </div>
                <div v-for="i in (selectedPassives.length < 7 ? 6 - selectedPassives.length : 0)" class="slot passive">
                  <div class="empty">PASSIVE</div>
                </div>
              </div>
            </div>
          </div>
          <div class="buttons">
            <div class="button" @click="reset()">RESET</div>
            <div class="button" @click="copy($event)">COPY LINK</div>
            <div class="button" @click="save()">SAVE IMAGE</div>
            <div class="button" @click="settings = !settings">SETTINGS</div>
          </div>
          <div v-if="settings" class="buttons settings">
            <div class="button" @click="config.pixels = !config.pixels">PIXELS: {{config.pixels ? 'ON' : 'OFF'}}</div>
            <div class="button" @click="config.titles = !config.titles">TITLES: {{config.titles ? 'ON' : 'OFF'}}</div>
            <div class="button" @click="config.evolutions = !config.evolutions">EVOLUTIONS: {{config.evolutions ? 'ON' : 'OFF'}}</div>
            <div class="flex">
              <div class="button" @click="config.size -= 0.1">SIZE -</div>
              <div class="button" @click="config.size += 0.1">SIZE +</div>
            </div>
          </div>
        </header>

        <!-- Characters -->
        <section style="max-width: 60em">
          <div class="objects">
            <div v-for="character in characters" :data-id="character.id" class="object character" :class="{selected: selectedCharacter && selectedCharacter.id === character.id}" @click="selectCharacter(character)" @mouseenter="onMouseEnter(character)" @mouseleave="onMouseLeave(character)">
              <div class="character sprite" :class="`sprite-${character.id}`" :title="character.name"></div>
              <div class="weapons">
                <div v-for="item in character.items" class="sprite" :class="`sprite-${item.id}`" :title="item.name"></div>
              </div>
              <div v-if="config.titles" class="title">{{character.id}}</div>
            </div>
          </div>
        </section>

        <!-- Weapons -->
        <section style="max-width: 65em">
          <div class="objects">
            <div v-for="weapon in weapons" :data-id="weapon.id" class="object weapon" :class="{selected: weapon.selected, center: !config.evolutions && !config.titles}" @click="toggleItem(weapon)" @mouseenter="onMouseEnter(weapon)" @mouseleave="onMouseLeave(weapon)">
              <div class="weapon">
                <div class="sprite" :class="`sprite-${weapon.id}`" :title="weapon.name"></div>
              </div>
              <div v-if="weapon.impacts && config.impacts" class="impacts">
                <div v-for="impact in weapon.impacts" class="sprite" :class="`sprite-${impact.id}`" :title="impact.name"></div>
              </div>
              <div v-if="weapon.evolution && config.evolutions" class="evolutions">
                <div v-for="object in weapon.evolution.passives" class="sprite" :class="`sprite-${object.id}`" :title="object.name"></div>
              </div>
              <div v-if="config.titles" class="title">{{weapon.id}}</div>
            </div>
          </div>
        </section>

        <!-- Passives -->
        <section style="max-width: 45em">
          <div class="objects">
            <div v-for="passive in passives" :data-id="passive.id" class="object passive" :class="{selected: passive.selected, center: !config.evolutions && !config.titles}" @click="toggleItem(passive)" @mouseenter="onMouseEnter(passive)" @mouseleave="onMouseLeave(passive)">
              <div class="passive" :title="passive.name">
                <div class="sprite" :class="`sprite-${passive.id}`"></div>
              </div>
              <div v-if="passive.evolution && config.evolutions" class="weapons">
                <div v-for="item in passive.evolution.weapons" class="sprite" :class="`sprite-${item.id}`" :title="item.name"></div>
              </div>
              <div v-if="config.titles" class="title">{{passive.id}}</div>
            </div>
          </div>
        </section>

        <!-- Arcanas -->
        <section style="max-width: 55em">
          <div class="objects">
            <div v-for="arcana in arcanas" :data-id="arcana.id" class="object arcana center" :class="{selected: arcana.selected}" @click="toggleItem(arcana)" @mouseenter="onMouseEnter(arcana)" @mouseleave="onMouseLeave(arcana)">
              <div class="arcana">
                <div class="sprite" :class="`sprite-${arcana.id}`" :title="arcana.name"></div>
              </div>
            </div>
          </div>
        </section>

        <!-- Footer -->
        <footer>
          <small class="socials">
            <span>Vampire Survivors:</span>
            <a class="social" href="https://store.steampowered.com/app/1794680/Vampire_Survivors/" target="_blank"><img src="./img/steam.svg" alt="" /></a>
            <a class="social" href="https://twitter.com/poncle_vampire" target="_blank"><img src="./img/twitter.svg" alt="" /></a>
            <a class="social" href="https://www.instagram.com/vampire_survivors/" target="_blank"><img src="./img/instagram.svg" alt="" /></a>
            <a class="social" href="https://www.tiktok.com/@vampire_survivors" target="_blank"><img src="./img/tiktok.svg" alt="" /></a>
            <a class="social" href="https://discord.com/invite/vampire-survivors" target="_blank"><img src="./img/discord.svg" alt="" /></a>
            <a class="social" href="https://www.reddit.com/r/VampireSurvivors/" target="_blank"><img src="./img/reddit.svg" alt="" /></a>
          </small>
          <small>Website is made by <a class="author" href="mailto:danmer.ekb@gmail.com">Danmer</a>, 2022</small>
        </footer>
      </main>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.32/vue.global.prod.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <script>
      const { createApp, ref, reactive, computed, watch, watchEffect, nextTick } = Vue

      createApp({
        setup() {
          const defaultConfig = { impacts: false, pixels: true, titles: true, evolutions: true, size: 1, version: '0.5.0' }
          const userConfig = JSON.parse(localStorage.getItem('vs-build') || '{}')
          const config = reactive(Object.assign({}, defaultConfig, userConfig))

          const settings = ref(false)

          const hashIds = location.hash.substring(1).split(',')

          const characters = reactive([
            { id: 'antonio', name: 'Antonio', itemIds: ['whip'] },
            { id: 'imelda', name: 'Imelda', itemIds: ['magicwand'] },
            { id: 'pasqualina', name: 'Pasqualina', itemIds: ['runetracer'] },
            { id: 'gennaro', name: 'Gennaro', itemIds: ['knife'] },
            { id: 'arca', name: 'Arca', itemIds: ['firewand'] },
            { id: 'porta', name: 'Porta', itemIds: ['lightning'] },
            { id: 'lama', name: 'Lama', itemIds: ['axe'] },
            { id: 'poe', name: 'Poe', itemIds: ['garlic'] },
            { id: 'clerici', name: 'Clerici', itemIds: ['water'] },
            { id: 'dommario', name: 'Dommario', itemIds: ['bible'] },
            { id: 'krochi', name: 'Krochi', itemIds: ['cross'] },
            { id: 'christine', name: 'Christine', itemIds: ['pentagram'] },
            { id: 'pugnala', name: 'Pugnala', itemIds: ['guns1', 'guns2'] },
            { id: 'poppea', name: 'Poppea', itemIds: ['mana'] },
            { id: 'mortaccio', name: 'Mortaccio', itemIds: ['bone'] },
            { id: 'cavallo', name: 'Cavallo', itemIds: ['cherry'] },
            { id: 'ramba', name: 'Ramba', itemIds: ['cart'] },
            { id: 'giovanna', name: 'Giovanna', itemIds: ['cat'] },
            { id: 'exdash', name: 'Exdash', itemIds: ['bird2'], secret: true },
            { id: 'toastie', name: 'Toastie', itemIds: ['bird1'], secret: true },
            { id: 'reaper', name: 'Reaper', itemIds: ['axe_'], secret: true },
            { id: 'leda', name: 'Leda', itemIds: ['magicwand_'], secret: true },
          ])

          const weapons = reactive([
            { id: 'magicwand', name: 'Magic Wand' },
            { id: 'firewand', name: 'Fire Wand' },
            { id: 'axe', name: 'Axe' },
            { id: 'lightning', name: 'Lightning Ring' },
            { id: 'knife', name: 'Knife' },
            { id: 'bible', name: 'King Bible' },
            { id: 'cross', name: 'Cross' },
            { id: 'garlic', name: 'Garlic' },
            { id: 'pentagram', name: 'Pentagram' },
            { id: 'runetracer', name: 'Runetracer' },
            { id: 'water', name: 'Santa Water' },
            { id: 'mana', name: 'Song of Mana' },
            { id: 'whip', name: 'whip' },
            { id: 'guns1', name: 'Phiera Der Tuphello' },
            { id: 'guns2', name: 'Eight The Sparrow' },
            { id: 'bird1', name: 'Peachone' },
            { id: 'bird2', name: 'Ebony Wings' },
            { id: 'lancet', name: 'Clock Lancet' },
            { id: 'laurel', name: 'Laurel' },
            { id: 'bone', name: 'bone' },
            { id: 'cherry', name: 'Cherry Bomb' },
            { id: 'cart', name: 'CarrÃ©llo' },
            { id: 'cat', name: 'Gatti Amari' },
          ])

          const evolutions = reactive([
            { id: 'magicwand_', name: 'Holy Wand', itemIds: ['magicwand', 'cooldown'] },
            { id: 'firewand_', name: 'Hellfire', itemIds: ['firewand', 'might'] },
            { id: 'axe_', name: 'Death Spiral', itemIds: ['axe', 'area'] },
            { id: 'lightning_', name: 'Thunder Loop', itemIds: ['lightning', 'amount'] },
            { id: 'knife_', name: 'Thousand Edge', itemIds: ['knife', 'speed'] },
            { id: 'bible_', name: 'Unholy Vespers', itemIds: ['bible', 'duration'] },
            { id: 'cross_', name: 'Heaven Sword', itemIds: ['cross', 'luck'] },
            { id: 'garlic_', name: 'Soul Eater', itemIds: ['garlic', 'recovery'] },
            { id: 'pentagram_', name: 'Gorgeous Moon', itemIds: ['pentagram', 'growth'] },
            { id: 'runetracer_', name: 'NO FUTURE', itemIds: ['runetracer', 'armor'] },
            { id: 'water_', name: 'La Borra', itemIds: ['water', 'magnet'] },
            { id: 'mana_', name: 'Mannajja', itemIds: ['mana', 'curse'] },
            { id: 'whip_', name: 'Bloody Tear', itemIds: ['whip', 'health'] },
            { id: 'guns_', name: 'Phieraggi', itemIds: ['guns1', 'guns2', 'revival'] },
            { id: 'bird_', name: 'Vandalier', itemIds: ['bird1', 'bird2'] },
          ])

          const passives = reactive([
            { id: 'cooldown', name: 'Empty tome', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'pentagram', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'lancet', 'laurel', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'pentagram_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { id: 'might', name: 'Spinach', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { id: 'area', name: 'Candelabrador', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'garlic', 'runetracer', 'water', 'mana', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'garlic_', 'runetracer_', 'water_', 'mana_', 'whip_', 'guns_', 'bird_'] },
            { id: 'amount', name: 'Duplicator', impactIds: ['magicwand', 'firewand', 'axe', 'lightning', 'knife', 'bible', 'cross', 'runetracer', 'water', 'whip', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'lightning_', 'knife_', 'bible_', 'cross_', 'runetracer_', 'water_', 'whip_', 'guns_', 'bird_'] },
            { id: 'speed', name: 'Bracer', impactIds: ['magicwand', 'firewand', 'axe', 'knife', 'bible', 'cross', 'runetracer', 'guns1', 'guns2', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'cart', 'magicwand_', 'firewand_', 'axe_', 'knife_', 'bible_', 'cross_', 'runetracer_', 'water_', 'guns_', 'bird_'] },
            { id: 'duration', name: 'Spellbinder', impactIds: ['bible', 'runetracer', 'water', 'mana', 'bird1', 'bird2', 'bone', 'cherry', 'cat', 'lancet', 'bible_', 'runetracer_', 'water_', 'mana_', 'bird_'] },
            { id: 'luck', name: 'Clover', impactIds: ['knife', 'pentagram', 'guns1', 'guns2', 'cherry', 'cat', 'knife_', 'cross_', 'whip_', 'guns_'] },
            { id: 'recovery', name: 'Pummarola', impactIds: ['garlic_'] },
            { id: 'growth', name: 'Crown' },
            { id: 'armor', name: 'Armor' },
            { id: 'magnet', name: 'Attractorb' },
            { id: 'curse', name: "Skull O'Maniac" },
            { id: 'health', name: 'Hollow Heart' },
            { id: 'revival', name: 'TiragisÃº', impactIds: ['guns_'] },
            { id: 'wings', name: 'Wings', impactIds: ['bird1', 'bird2', 'water_', 'bird_'] },
            { id: 'greed', name: 'Stone Mask' },
          ])

          const arcanas = reactive([
            { id: 'arcana4', name: 'Awake', impactIds: ['revival', 'health', 'armor', 'might', 'area', 'duration', 'wings'] },
            { id: 'arcana5', name: 'Chaos in the Dark Night', impactIds: ['speed'] },
            { id: 'arcana6', name: 'Sarabande of Healing', impactIds: ['recovery', 'whip_', 'garlic_', 'revival'] },
            { id: 'arcana16', name: 'Slash', impactIds: ['knife', 'knife_', 'whip', 'whip_', 'axe', 'axe_', 'cross_'] },
            { id: 'arcana17', name: 'Lost & Found Painting', impactIds: ['duration'] },
            { id: 'arcana19', name: 'Heart of Fire', impactIds: ['firewand', 'firewand_'] },
          ])

          const items = characters.concat(weapons, passives, evolutions, arcanas)
          const itemsById = keyById(items)
          const weaponsById = keyById(weapons)
          const passivesById = keyById(passives)
          const evolutionsById = keyById(evolutions)
          const arcanasById = keyById(arcanas)

          for (const evolution of evolutions) {
            evolution.selected = hashIds.includes(evolution.id)
            evolution.itemIds = evolution.itemIds || []
            evolution.items = evolution.itemIds.map((itemId) => itemsById[itemId])
            evolution.weaponIds = evolution.itemIds.filter((itemId) => weaponsById[itemId])
            evolution.weapons = evolution.weaponIds.map((itemId) => weaponsById[itemId])
            evolution.passiveIds = evolution.itemIds.filter((itemId) => passivesById[itemId])
            evolution.passives = evolution.passiveIds.map((itemId) => passivesById[itemId])
            for (const item of evolution.items) {
              item.evolutionId = evolution.id
              item.evolution = evolution
            }
          }

          for (const weapon of weapons) {
            weapon.selected = hashIds.includes(weapon.id)
            weapon.impacts = passives.filter((passive) => passive.impactIds && passive.impactIds.includes(weapon.id))
            weapon.impactIds = weapon.impacts.map((impact) => impact.id)
          }

          for (const passive of passives) {
            passive.selected = hashIds.includes(passive.id)
            passive.impactIds = passive.impactIds || []
            passive.impacts = passive.impactIds.map((impactId) => weapons.find((weapon) => weapon.id === impactId))
          }

          for (const arcana of arcanas) {
            arcana.impactIds = arcana.impactIds || []
            arcana.impacts = items.filter((item) => arcana.impactIds.includes(item.id))
          }

          for (const character of characters) {
            character.itemIds = character.itemIds || []
            character.items = items.filter((item) => character.itemIds.includes(item.id))
          }

          const preselectedCharacter = characters.find((character) => hashIds.includes(character.id))
          if (preselectedCharacter) {
            preselectedCharacter.selected = true
          }

          const selectedCharacter = computed(() => characters.find((character) => character.selected) || { id: '', itemIds: [], items: [] })
          const selectedWeapons = computed(() =>
            weapons.concat(evolutions).reduce((result, weapon) => {
              if (weapon.selected) {
                const maybeEvolution = weapon.evolved ? weapon.evolution : weapon
                if (!result.find((item) => item.id === maybeEvolution.id)) {
                  if (weapon.fixed) {
                    result.unshift(maybeEvolution)
                  } else {
                    result.push(maybeEvolution)
                  }
                }
              }
              return result
            }, [])
          )
          const selectedPassives = computed(() => passives.filter((passive) => passive.selected))
          const selectedArcanas = computed(() => arcanas.filter((arcana) => arcana.selected))

          window.vs = { config, items, characters, weapons, passives, evolutions }
          console.log(window.vs)

          watchEffect(() => {
            location.hash = characters
              .concat(weapons, passives, arcanas)
              .filter((item) => item.selected)
              .map((item) => item.id)
              .join()
            for (const evolution of evolutions) {
              evolution.fixed = selectedCharacter.value.itemIds.includes(evolution.id)
            }
            for (const weapon of weapons) {
              weapon.evolved = weapon.evolution && (weapon.evolution.items.every((item) => item.selected) || selectedCharacter.value.itemIds.includes(weapon.evolution.id))
              weapon.fixed = selectedCharacter.value.itemIds.includes(weapon.id) || (weapon.evolution && weapon.evolution.fixed)
            }
          })

          watch(
            selectedCharacter,
            (newCharacter, oldCharacter) => {
              if (oldCharacter && oldCharacter.itemIds) {
                for (const item of oldCharacter.items) {
                  item.selected = false
                }
              }
              if (newCharacter && newCharacter.itemIds) {
                for (const item of newCharacter.items) {
                  item.selected = true
                }
              }
            },
            { immediate: true }
          )

          watch(config, () => {
            for (const param in config) {
              if (config[param] === defaultConfig[param]) {
                delete userConfig[param]
              } else {
                userConfig[param] = config[param]
              }
            }
            localStorage.setItem('vs-build', JSON.stringify(userConfig))
          })

          function onMouseEnter(object) {
            if (!object) {
              return
            }
            if (object.itemIds) {
              for (const item of object.items) {
                document.querySelectorAll(`[data-id="${item.id}"]`).forEach((element) => {
                  element.classList.add('yellow')
                })
                if (item.evolved) {
                  document.querySelectorAll(`[data-id="${item.evolutionId}"]`).forEach((element) => {
                    element.classList.add('yellow')
                  })
                }
              }
            }
            if (object.evolution) {
              for (const itemId of object.evolution.itemIds.concat(object.evolutionId)) {
                if (object.id !== itemId) {
                  document.querySelectorAll(`[data-id="${itemId}"]`).forEach((element) => {
                    element.classList.add('yellow')
                  })
                }
              }
            }
            if (object.impactIds) {
              for (const impactId of object.impactIds) {
                document.querySelectorAll(`[data-id="${impactId}"]`).forEach((element) => {
                  element.classList.add('green')
                })
              }
            }
          }

          function onMouseLeave() {
            document.querySelectorAll(`.yellow, .green`).forEach((element) => {
              element.classList.remove('yellow', 'green')
            })
          }

          function selectCharacter(newCharacter) {
            if (selectedCharacter.value.selected) {
              selectedCharacter.value.selected = false
              onMouseLeave()
            }
            newCharacter.selected = true
            nextTick(() => {
              onMouseEnter(newCharacter)
            })
          }

          function toggleItem(item) {
            if (item.weaponIds) {
              for (const weapon of item.weapons) {
                toggleItem(weapon)
              }
            } else {
              if (item.selected) {
                // prevent removing the selected chracter's weapon
                if (!item.fixed) {
                  item.selected = false
                  onMouseLeave()
                }
              } else {
                if (item.type === 'arcana' && selectedArcanas.value.length > 2) {
                  return
                }
                item.selected = true
                nextTick(() => {
                  onMouseEnter(item)
                })
              }
            }
          }

          function reset() {
            for (const item of items) {
              item.selected = false
            }
          }

          function save() {
            domtoimage.toPng(document.querySelector('.slots')).then((dataUrl) => {
              var link = document.createElement('a')
              link.download = `vs-build_${new Date().toISOString().substring(0, 19).replaceAll(':', '-')}.png`
              link.href = dataUrl
              link.click()
              // window.saveAs(blob, 'my-node.png');
            })
          }

          function copy(event) {
            const text = location.href
            navigator.clipboard.writeText(text).then(() => {
              const target = event.target
              if (target) {
                target.style.color = '#3c3'
                setTimeout(() => {
                  target.style.color = ''
                }, 200)
              }
            })
          }

          function keyById(items) {
            return items.reduce((object, item) => {
              object[item.id] = item
              return object
            }, {})
          }

          return {
            config,
            settings,
            characters,
            weapons,
            passives,
            evolutions,
            arcanas,
            selectedCharacter,
            selectedWeapons,
            selectedPassives,
            selectedArcanas,
            onMouseEnter,
            onMouseLeave,
            selectCharacter,
            toggleItem,
            save,
            copy,
            reset,
          }
        },
      }).mount('#app')
    </script>

    <!-- Yandex.Metrika counter -->
    <script type="text/javascript">
      ;(function (m, e, t, r, i, k, a) {
        m[i] =
          m[i] ||
          function () {
            ;(m[i].a = m[i].a || []).push(arguments)
          }
        m[i].l = 1 * new Date()
        ;(k = e.createElement(t)), (a = e.getElementsByTagName(t)[0]), (k.async = 1), (k.src = r), a.parentNode.insertBefore(k, a)
      })(window, document, 'script', 'https://mc.yandex.ru/metrika/tag.js', 'ym')
      ym(88260279, 'init', { clickmap: true, trackLinks: true, accurateTrackBounce: true, webvisor: true, trackHash: true })
    </script>
    <noscript>
      <div><img src="https://mc.yandex.ru/watch/88260279" style="position: absolute; left: -9999px" alt="" /></div>
    </noscript>
    <!-- /Yandex.Metrika counter -->
  </body>
</html>
